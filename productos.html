<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Productos | Gesti√≥n</title>
  <link rel="stylesheet" href="../css/stylepag.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card {
      background: #fff;
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .1);
      width: 100%;
      max-width: 1100px;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 16px;
    }
    .back-btn:hover { background: #0056b3; }
    h1 { text-align: center; color: #003366; margin-bottom: 25px; }
    form {
      display: flex; flex-wrap: wrap; gap: 10px;
      margin-bottom: 20px; justify-content: center;
    }
    form input, form select {
      flex: 1 1 200px; padding: 10px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    form button {
      flex: 1 1 150px; padding: 10px; font-weight: bold;
      font-size: 15px; background: #28a745; color: #fff;
      border: none; border-radius: 6px; cursor: pointer;
    }
    form button:hover { background: #218838; }
    #msg { text-align: center; margin-bottom: 10px; font-weight: bold; }
    #buscar {
      margin-bottom: 15px; padding: 8px; width: 100%;
      max-width: 400px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc; padding: 8px; text-align: center; font-size: 14px;
    }
    th { background: #28a745; color: #fff; }
    tr:nth-child(even) { background: #f9f9f9; }
    td input {
      width: 100%; border: none; background: transparent; text-align: center;
    }
    td input:focus { outline: 1px solid #003366; border-radius: 4px; }
    .btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .save { background: #007bff; color: #fff; }
    .delete { background: #dc3545; color: #fff; margin-left: 4px; }
    .agotado { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="card">
    <button class="back-btn" onclick="window.location.href='homepage.html'">‚óÄÔ∏è Volver</button>
    <h1>Gesti√≥n de Productos</h1>

    <form id="formProducto">
      <input id="cod_producto" placeholder="C√≥digo producto" required />
      <input id="Marca" placeholder="Marca" required />
      <input id="Descripci√≥n" placeholder="Descripci√≥n" required />
      <input id="stock" placeholder="Stock" type="number" min="0" required />
      <select id="cod_inventario" required>
        <option value="">Seleccionar Inventario</option>
        <option value="Inventario Tienda">Tienda</option>
        <option value="Inventario Caba√±a">Caba√±a</option>
        <option value="Inventario Terreno">Terreno</option>
      </select>
      <button type="submit">Registrar</button>
    </form>

    <div id="msg"></div>

    <input type="text" id="buscar" placeholder="Buscar productos por c√≥digo, marca o descripci√≥n..." />

    <table>
      <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Marca</th>
          <th>Descripci√≥n</th>
          <th>Stock</th>
          <th>Ubicaci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js';

    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBMHH7tdFm5EpZazWSe604_05UH_ljszGI",
      authDomain: "bitel-247cf.firebaseapp.com",
      projectId: "bitel-247cf",
      storageBucket: "bitel-247cf.appspot.com",
      messagingSenderId: "773176941580",
      appId: "1:773176941580:web:4c219da54d05f14f4b6229"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById('formProducto');
    const msg = document.getElementById('msg');
    const tbody = document.getElementById('tbody');
    let editandoId = null;

    // Registrar o actualizar producto
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const stockValue = form.stock.value;
      if (isNaN(stockValue) || stockValue.trim() === '' || Number(stockValue) < 0) {
        msg.textContent = '‚ùå El stock debe ser un n√∫mero v√°lido';
        msg.style.color = 'red';
        return;
      }

      const producto = {
        cod_producto: form.cod_producto.value,
        nombre: form.Marca.value,
        descripcion: form.Descripci√≥n.value,
        stock: Number(stockValue),
        cod_inventario: form.cod_inventario.value
      };

      try {
        if (editandoId) {
          await updateDoc(doc(db, 'productos', editandoId), producto);
          msg.textContent = '‚úÖ Producto actualizado';
          msg.style.color = '#28a745';
          editandoId = null;
        } else {
          await addDoc(collection(db, 'productos'), producto);
          msg.textContent = '‚úÖ Producto registrado';
          msg.style.color = '#28a745';
        }
        form.reset();
      } catch (error) {
        msg.textContent = '‚ùå Error al guardar';
        msg.style.color = 'red';
        console.error(error);
      }
      setTimeout(() => msg.textContent = '', 2000);
    });

    // Mostrar productos en la tabla
    function listarProductos() {
      onSnapshot(collection(db, 'productos'), (snapshot) => {
        tbody.innerHTML = '';
        snapshot.forEach((docu) => {
          const data = docu.data();
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input value="${data.cod_producto || ''}" data-field="cod_producto" data-id="${docu.id}" /></td>
            <td><input value="${data.nombre || ''}" data-field="nombre" data-id="${docu.id}" /></td>
            <td><input value="${data.descripcion || ''}" data-field="descripcion" data-id="${docu.id}" /></td>
            <td>
              ${Number(data.stock) === 0
                ? '<span class="agotado">Agotado</span>'
                : `<input type="number" min="0" value="${data.stock || 0}" data-field="stock" data-id="${docu.id}" />`}
            </td>
            <td><input value="${data.cod_inventario || ''}" data-field="cod_inventario" data-id="${docu.id}" /></td>
            <td>
              <button class="btn save" data-id="${docu.id}">üíæ</button>
              <button class="btn delete" data-id="${docu.id}">üóëÔ∏è</button>
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Bot√≥n Eliminar
        document.querySelectorAll('.delete').forEach(btn => {
          btn.addEventListener('click', async () => {
            await deleteDoc(doc(db, 'productos', btn.dataset.id));
            msg.textContent = 'üóëÔ∏è Producto eliminado';
            msg.style.color = '#28a745';
            setTimeout(() => msg.textContent = '', 2000);
          });
        });

        // Bot√≥n Guardar
        document.querySelectorAll('.save').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const inputs = document.querySelectorAll(`input[data-id="${id}"]`);
            const nuevoProducto = {};
            let valido = true;

            inputs.forEach(input => {
              if (input.dataset.field === 'stock') {
                if (isNaN(input.value) || input.value.trim() === '' || Number(input.value) < 0) {
                  msg.textContent = '‚ùå El stock debe ser un n√∫mero v√°lido';
                  msg.style.color = 'red';
                  valido = false;
                }
                nuevoProducto[input.dataset.field] = Number(input.value);
              } else {
                nuevoProducto[input.dataset.field] = input.value;
              }
            });

            if (!valido) return;

            await updateDoc(doc(db, 'productos', id), nuevoProducto);
            msg.textContent = '‚úÖ Producto actualizado';
            msg.style.color = '#28a745';
            setTimeout(() => msg.textContent = '', 2000);
          });
        });
      });
    }
    listarProductos();

    // Filtro de b√∫squeda
    document.getElementById('buscar').addEventListener('input', function () {
      const filtro = this.value.toLowerCase();
      const filas = document.querySelectorAll('#tbody tr');
      filas.forEach(fila => {
        const codigo = fila.cells[0].querySelector('input')?.value.toLowerCase() || '';
        const marca = fila.cells[1].querySelector('input')?.value.toLowerCase() || '';
        const descripcion = fila.cells[2].querySelector('input')?.value.toLowerCase() || '';
        if (codigo.includes(filtro) || marca.includes(filtro) || descripcion.includes(filtro)) {
          fila.style.display = '';
        } else {
          fila.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
